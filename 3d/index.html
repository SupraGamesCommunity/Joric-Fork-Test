<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Joric's Supraland 3D</title>
<style type="text/css">
html,body{margin:0px;height:100%;width:100%; font-family:sans-serif;}
.container{width:100%;height:100%}
</style>
<link rel="stylesheet" href="https://unpkg.com/maptalks/dist/maptalks.css">
<script type="text/javascript" src="https://unpkg.com/maptalks/dist/maptalks.min.js"></script>
<body>
<div id="map" class="container"></div>
<script>

let markerColors = ['#48a1c2','#419869','#f4bd76','#e4e1d6','#88cf78'];
let markerColor = markerColors[4];
let lineColor = markerColor;//'#888';
let startPitch = 45;
let startZoom = 3;
let altitudeScale = 0.25;
let drawMode = 2; // 0: pins and icons (separate layers),  1: just icons, 2: compound markers
let map = null;

icons = {'Chest_C':{icon:'chest', color:0 }, 'Bones_C': {icon:'bones', color:2}, 'Scrap_C': {icon:'scrap', color:4} };
//icons = {'Chest_C':{icon:'chest', color:4 }};

let maps = {
  // data taken from the MapWorld* nodes
  'sl':  { 
      title: 'Supraland',
      "MapWorldCenter": { "X": 13000.0, "Y": -2000.0, "Z": 0.0 },
      "MapWorldSize": 175000.0,
      "MapWorldUpperLeft": { "X": -74500.0, "Y": -89500.0, "Z": 0.0 },
      "MapWorldLowerRight": { "X": 100500.0, "Y": 85500.0, "Z": 0.0 },
  },

  'slc': {
    title: 'Supraland Crash',
      "MapWorldCenter": { "X": 25991.0, "Y": -16.0, "Z": 0.0  },
      "MapWorldSize": 90112.0,
      "MapWorldUpperLeft": { "X": -19065.0, "Y": -45040.0, "Z": 0.0 },
      "MapWorldLowerRight": { "X": 71047.0, "Y": 45072.0, "Z": 0.0 },
  },

  'siu': {
      title: 'Supraland Six Inches Under',
      "MapWorldCenter": { "X": 0.0, "Y": -19000.0, "Z": 10000.0 },
      "MapWorldSize": 147456.0,
      "MapWorldUpperLeft": { "X": -73728.0, "Y": -92728.0, "Z": 10000.0 },
      "MapWorldLowerRight": { "X": 73728.0, "Y": 54728.0, "Z": 10000.0 },
  },
};

function loadMap(mapId) {
  location.hash = mapId;

  document.querySelector('#map').style.backgroundColor = mapId=='siu' ? '#141414' : '#000';

  if (map) {
    map.remove();
  }

  let p = maps[mapId];
  let mapSize = {width: 8192, height: 8192}
  let scale = p.MapWorldSize / mapSize.width;
  let [left,top,right,bottom] = [p.MapWorldUpperLeft.X, p.MapWorldUpperLeft.Y, p.MapWorldLowerRight.X, p.MapWorldLowerRight.Y];
  let extent = new maptalks.Extent(left, top, right, bottom);

  map = new maptalks.Map('map', {
    zoom: startZoom,
    pitch: startPitch,
    center: [p.MapWorldCenter.X, p.MapWorldCenter.Y],
    spatialReference : {
      projection : 'identity',
      resolutions : (function() {
        const res = [];
        for (let i=32; i>0.125; i/=2) {
          res.push(i*scale);
        }
        return res;
      })(),
      fullExtent : {
        top:  top,
        left: left,
        bottom: bottom,
        right: right,
      }
    },
    baseLayer: new maptalks.TileLayer('base', {
      maxAvailableZoom: 4,
      urlTemplate: '../tiles/'+mapId+'/base/{z}/{x}/{y}.jpg',
      repeatWorld: false,
      tileSystem: [1, -1, left, top],
      attribution: '<a href="https://github.com/joric/supraland" target="_blank">Joric\'s Supraland</a>',
    }),
    seamlessZoom: true,
    doubleClickZoom: true,
    zoomControl: {
      'position'  : 'top-right',
      'zoomLevel' : false,
    },
    compassControl: {
      position: 'bottom-right',
    },
  });

  let vectorLayer = new maptalks.VectorLayer('vector', {
    enableAltitude: true,
    sortByDistanceToCamera: true,
    drawAltitude : {
      lineWidth : 1.5,
      lineColor : '#ccc',//lineColor,
      //lineDasharray : [2, 2],
    },
  }).addTo(map);

  let iconLayer = new maptalks.VectorLayer('icons', {
    enableAltitude: true,
    sortByDistanceToCamera: true,
  }).addTo(map);

  if (drawMode!=1) {
    iconLayer.setOptions({
      drawAltitude: {
        lineWidth : 1.5,
        lineColor : '#ccc',
      },
    })
  }

  fetch('../data/markers.'+mapId+'.json')
    .then((response) => response.json())
    .then((j) => {
      for (o of j) {
        if (! (o.lng>left && o.lng<right && o.lat>top && o.lat<bottom )) {
          continue;
        }
        if (c = icons[o.type]) {

          if (drawMode==0) {

            // add pin symbol with altitude
            let pin = new maptalks.Marker([o.lng, o.lat, o.alt * altitudeScale],{
              symbol: {
                markerWidth: 77,
                markerHeight: 75,
                markerFill: markerColors[c.color],
                //markerLineColor: 'white',
                markerType: 'pin', //ellipse cross x diamond bar square triangle pin pie
              } 
            }).addTo(vectorLayer);

            // add icon on top of the pin
            var marker = new maptalks.Marker([o.lng, o.lat, o.alt * altitudeScale],{
              id: o.area+':'+o.name,
              properties: {
                  name: o.name,
              },
              symbol: {
                markerFile: '../img/'+c.icon+'.png',
                markerWidth  : 32,
                markerHeight : 32,
                markerDy: -22,
              }
            }).addTo(iconLayer);

          } else if (drawMode==1) {

            var marker = new maptalks.Marker([o.lng, o.lat, o.alt * altitudeScale],{
              id: o.area+':'+o.name,
              properties: {
                  name: o.name,
              },
              symbol: {
                markerFile: '../img/'+c.icon+'.png',
                markerWidth  : 32,
                markerHeight : 32,
              }
            }).addTo(iconLayer);

          } else {
            var marker = new maptalks.Marker([o.lng, o.lat, o.alt * altitudeScale],{
              id: o.area+':'+o.name,
              properties: {
                  name: o.name,
              },
              symbol: [
                {
                  markerWidth: 75,
                  markerHeight: 75,
                  markerFill: markerColors[c.color],
                  markerType: 'pin',
                },
                {
                  markerFile: '../img/'+c.icon+'.png',
                  markerWidth  : 32,
                  markerHeight : 32,
                  markerDy: -22,
                },
              ],
            }).addTo(vectorLayer);
          }

          let text = JSON.stringify(o, null, 2).replaceAll('\n','<br>').replaceAll(' ','&nbsp;');

          const tooltip = new maptalks.ui.ToolTip(o.name, {
              content: 'hello',
          }).addTo(marker);

          marker.setInfoWindow({
            title     : o.name,
            content   : text,
            // 'autoPan': true,
            // 'width': 300,
            // 'minHeight': 120,
            // 'custom': false,
            //'autoOpenOn' : 'click',  //set to null if not to open when clicking on marker
            autoCloseOn : 'click',
          });
        }
      }
   });


  /*
  map.on('resize moving moveend zooming zoomend rotate rotateend dragrotating dragrotateend viewchange', function(e){
     //console.log(e);
     //vectorLayer.setAltitude( map.getPitch()==0 ? 0 : 100);
     //vectorLayer.enableAltitude = false;
  });
  */

  //update();

  function update() {
    /*
    var projection = map.getProjection();
    var center = map.getCenter(),
      prj = projection.project(center),
      containerPoint = map.coordinateToContainerPoint(center).round();

    document.getElementById('coordinate').innerHTML = '<div>' + [
      'Center : [' + center.x.toFixed(5) + ', ' + center.y.toFixed(5) + ']',
      'Projected Coordinate : [' + prj.x.toFixed(5) + ', ' + prj.y.toFixed(5) + ']',
      'ContainerPoint is the screen position in px from northwest of the map container.',
      'ContainerPoint : [' + containerPoint.x + ', ' + containerPoint.y + ']'
    ].join('<br>') + '</div>';
    */
  }

  var toolbar = new maptalks.control.Toolbar({
    'position' : 'top-left',
    items: [
      { item : 'sl', click : function() { loadMap('sl'); }},
      { item : 'slc', click : function() { loadMap('slc'); }},
      { item : 'siu', click : function() { loadMap('siu'); }},
    ]
  }).addTo(map);

  document.querySelector('.maptalks-compass').onclick = function(e) {
    if (map.getBearing()==0) {
      map.animateTo({ pitch: map.getPitch()==0 ? 60 : 0 });
      vectorLayer.setOptions({
        enableAltitude: map.getPitch()==0,
      });
    }
  };

  map.on('rotate viewchange', function(e) {
    vectorLayer.setOptions({
      enableAltitude: map.getPitch()!=0,
    });
  });

  //map.fitExtent(extent); // commented out - too small, it fits in zoom 4

  /*
  // context menu
  var options = {
    'items'  : [
          {item: 'Copy Map View URL', click: function () { alert('Location copied.'); }},
      //'-',{item: 'item2', click: function () { alert('Click item2'); }}
    ]
  };
  map.setMenu(options);
  */

  // window.addEventListener('contextmenu', function(e) { e.stopPropagation()}, true); // enable default context menu

  [].forEach.call(document.querySelectorAll('.maptalks-toolbar-hx > li'), function(div) {
    if (div.innerText==mapId) {
      div.style.background = '#6a97d9';
      div.style.color = '#fff';
    }
  });
}

window.onload = function(event) {
  mapId = Object.keys(maps).find(id=>location.hash.endsWith(id)) || 'siu';
  loadMap(mapId);
};


</script>
</body>
</html>

